# k8s-gitops

Demo for provisioning infrastructure using [crossplane](https://docs.crossplane.io/) + [flux](https://fluxcd.io/flux/)

# Resource arrangement

All k8s esources are arranged under the `k8s/` directory. Every sub-directory name corresponds to the name of the k8s namespace, i.e, resources in the same namespace are stored together.

Every sub-directory is expected to have a `sync.yaml` and a `kustomization.yaml` (from `kustomize.config.k8s.io/v1beta1` and not `kustomize.toolkit.fluxcd.io/v1`) to enable syncing up with flux. Resources in the `sync.yaml` are always provisioned in the flux-system namespace. The `sync.yaml` can be considered as an entrypoint to your namespace / micro-service. It contains sync reconciliation mechanisms pertianing to any git repo / kustomize / image repo / image automation etc.

Most of the kustomize (`kustomize.toolkit.fluxcd.io/v1`) resources have a `depends_on` key that enables us to specify dependencies between kustomizations. This is particulary useful when deploying applications from scratch. For instance, before deploying provider configurations in the `crossplane-system` ns, it's crds must be available. Another instance of this would be applying django migrations before the application startup (in this demo), read more [here](https://fluxcd.io/flux/use-cases/running-jobs/).

# Setup

You'll need to fork the repo to follow along.

The first step is to create a service account in gcp. A `Makefile` in the root of this repo contains command for creating a service account, role binding and the service account keys. For more info, visit [here](https://docs.crossplane.io/v1.13/getting-started/provider-gcp/#create-a-kubernetes-secret-for-gcphttps://docs.crossplane.io/v1.13/getting-started/provider-gcp/#create-a-kubernetes-secret-for-gcp).

Edit the project id variable with your gcp project id and run the following command:

```
make service-account
```

This command stores the service account keys in a `gcp-credentials.json` which is gitignored by default.

> For demo purposes, the service account has an **Editor** and **Project IAM Admin** role. This should not be replicated in production.

We'll create a local cluster using [K3d](https://k3d.io/v5.4.1/) to act as the management plane for provisioning resources on the cloud. Feel free to skip the following command if you'd like to use gke-autopilot.

```
make k3d-create
```

Once your desired cluster is ready, install flux and [sealed-secrets](https://github.com/bitnami-labs/sealed-secrets):

```
flux bootstrap git \
  --author-email=<your-github-email> \
  --url=ssh://git@github.com/<your-username>/k8s-gitops.git \
  --branch=main \
  --path=k8s/ \
  --components-extra="image-reflector-controller,image-automation-controller"
```

Now that sealed-secrets controller is ready, use the following command to extract the public certificate, create a k8s secret for `gcp-credentials.json` and seal it:

```
make gcp-secret
```

The public certificate and the sealed secret generated by this command can be committed to git.

Install the crossplane components with:

```
kubectl apply -f k8s/crossplane-system/sync.yaml
```

This command provisions resources based on the order and dependencies specified in the `k8s/crossplane-system/sync.yaml`. See the `dependsOn` field.

It might take a while for resources to provision / reconcile. You can monitor the kustomize resource reconciliation with:

```
kubectl get ks -n flux-system
```

Once everything is ready, you can deploy gcp resources in the same manner as any other k8s resources i.e, with `kubectl apply` / `kubectl create`

To create and sync all resources with flux, deploy the `sync.yaml` file:

```
kubectl apply -f k8s/gcp-resources/sync.yaml
```

> For cloud build trigger to work you'd still have to manually connect the repository from the gcp console.

For the purpose of this demo there's a django app and postgres database which can be deployed with:

```
kubectl apply -f k8s/cnpg-system/sync.yaml
kubectl apply -f k8s/server/sync.yaml
```

As mentioned earlier, reconciliation can be monitored with

```
kubectl get ks -n flux-system
```

# TODO

- Add django app resources
- Provision service account / role binding
- Add istio
- Update istio / flux via gh-actions
- Combine gcp-resources using crossplane compositions
- Self-serve platform with [backstage](https://github.com/backstage/backstage) / [port](https://github.com/port-labs)?
